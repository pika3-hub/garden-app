{% extends "base.html" %}

{% block title %}{% if task %}タスク編集{% else %}タスク登録{% endif %} - 家庭菜園管理アプリ{% endblock %}

{% block body_bg %}<div class="page-bg-image page-bg-tasklist"></div>{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <img src="{{ url_for('static', filename='images/icon_tasklist.png') }}" alt="" class="icon-img icon-img-lg">
            {% if task %}タスク編集{% else %}タスク登録{% endif %}
        </h1>
    </div>
    <div class="col-md-4 text-end d-flex justify-content-end align-items-center">
        <button onclick="history.back()" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 戻る
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{% if task %}{{ url_for('tasks.update', task_id=task.id) }}{% else %}{{ url_for('tasks.create') }}{% endif %}" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="title" class="form-label">タイトル <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ task.title if task else '' }}" required>
                            <div class="invalid-feedback">タイトルを入力してください</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">ステータス</label>
                            <select class="form-select" id="status" name="status">
                                <option value="pending" {% if not task or task.status == 'pending' %}selected{% endif %}>未着手</option>
                                <option value="in_progress" {% if task and task.status == 'in_progress' %}selected{% endif %}>進行中</option>
                                <option value="completed" {% if task and task.status == 'completed' %}selected{% endif %}>完了</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="due_date" class="form-label">期限日</label>
                        <input type="date" class="form-control" id="due_date" name="due_date" value="{{ task.due_date if task and task.due_date else '' }}">
                        <small class="text-muted">期限がある場合は指定してください</small>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">説明</label>
                        <textarea class="form-control" id="description" name="description" rows="6" placeholder="タスクの詳細を記入してください">{{ task.description if task else '' }}</textarea>
                    </div>

                    <hr class="my-4">
                    <h5 class="mb-3"><i class="bi bi-link-45deg"></i> 関連付け</h5>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="crop_ids" class="form-label">作物</label>
                            <select class="form-select" id="crop_ids" name="crop_ids" multiple size="5">
                                {% for crop in crops %}
                                <option value="{{ crop.id }}" {% if selected_relations and crop.id|string in selected_relations.crop_ids %}selected{% endif %}>
                                    {{ crop.name }}{% if crop.variety %}（{{ crop.variety }}）{% endif %} ({{ crop.crop_type }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ctrlキーで複数選択可</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="location_ids" class="form-label">場所</label>
                            <select class="form-select" id="location_ids" name="location_ids" multiple size="5">
                                {% for loc in locations %}
                                <option value="{{ loc.id }}" {% if selected_relations and loc.id|string in selected_relations.location_ids %}selected{% endif %}>
                                    {{ loc.name }} ({{ loc.location_type }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ctrlキーで複数選択可</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="location_crop_ids" class="form-label">植え付け</label>
                            <select class="form-select" id="location_crop_ids" name="location_crop_ids" multiple size="5">
                                {% for lc in location_crops %}
                                <option value="{{ lc.id }}" {% if selected_relations and lc.id|string in selected_relations.location_crop_ids %}selected{% endif %}>
                                    {{ lc.crop_name }} @ {{ lc.location_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Ctrlキーで複数選択可</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{{ url_for('tasks.list') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> キャンセル
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> {% if task %}更新{% else %}登録{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> 入力のヒント</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>タイトル</strong><br>
                    <small>タスクのタイトルを入力します（例: 追肥作業、支柱立て）</small>
                </p>
                <p class="mb-2"><strong>ステータス</strong><br>
                    <small>未着手・進行中・完了から選択します</small>
                </p>
                <p class="mb-2"><strong>期限日</strong><br>
                    <small>期限がある場合は日付を指定します</small>
                </p>
                <p class="mb-2"><strong>説明</strong><br>
                    <small>タスクの詳細内容を自由に記入できます</small>
                </p>
                <p class="mb-0"><strong>関連付け</strong><br>
                    <small>関連する作物・場所・植え付けを選択できます。Ctrlキーを押しながらクリックで複数選択可能です</small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
